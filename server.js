require('dotenv').config();
const express = require('express');
const app = express();

const PORT = process.env.PORT || 3000;

// ==========================================================
// ×©×œ×‘ ×§×¨×™×˜×™: ×ª×ž×—×§ ××ª ×”×˜×§×¡×˜ ×œ×ž×˜×” ×•×ª×“×‘×™×§ ××ª ×”×ž×¤×ª×— *×”×—×“×©* ×©×œ×š ×‘×ª×•×š ×”×ž×¨×›××•×ª
// ××œ ×ª×¤×¨×¡× ××ª ×”×ž×¤×ª×— ×”×—×“×© ×‘×¦'××˜!
const API_KEY = "AIzaSyAMxGeSPFpgvnGS-7IBOCJcLX1GDdGRcJY";
// ==========================================================

app.use(express.json());
app.use(express.static('public'));

const questions = [
    { id: 1, text: "×œ×ž×” ×‘×—×¨×ª ×œ×”×’×™×© ×ž×•×¢×ž×“×•×ª ×“×•×•×§× ×œ××“×™×“×¡, ×•×ž×” ×”×—×™×‘×•×¨ ×©×œ×š ×œ×¡×¤×•×¨×˜?", type: "text" },
    { id: 2, text: "×œ×§×•×— ×ž×ª×œ×‘×˜ ×œ×’×‘×™ × ×¢×œ ×¨×™×¦×” ×ž×§×¦×•×¢×™×ª ×•×™×§×¨×” (×œ×ž×©×œ Ultraboost). ×”×•× ×˜×•×¢×Ÿ ×©×–×” ×™×§×¨ ×œ×•. ××™×š ×ª×©×›× ×¢ ××•×ª×• ×©×–×• ×”×”×©×§×¢×” ×”× ×›×•× ×”?", type: "text" },
    { id: 3, text: "×”×—× ×•×ª ×¢×ž×•×¡×” ×ž××•×“, ××ª×” ×œ×‘×“ ×‘×ž×—×œ×§×”, ×•-3 ×œ×§×•×—×•×ª ×©×•× ×™× ×¤×•× ×™× ××œ×™×š ×œ×¢×–×¨×” ×‘×• ×–×ž× ×™×ª. ××™×š ×ª×ª×¢×“×£ ×•×ª×¤×¢×œ?", type: "text" },
    { id: 4, text: "×œ×§×•×— × ×›× ×¡ ×›×•×¢×¡ ×ž××•×“ ×‘×˜×¢× ×” ×©× ×¢×œ×™×™× ×©×§× ×” ×œ×¤× ×™ ×©×‘×•×¢ × ×§×¨×¢×•. ×”×•× ×ž×¨×™× ××ª ×”×§×•×œ. ××™×š ×ª×’×™×‘ ×•×ž×” ×ª×¢×©×”?", type: "text" },
    { id: 5, text: "×‘×ž×”×œ×š ×ž×©×ž×¨×ª ×¢×ž×•×¡×”, ×”×ž× ×”×œ ×ž×‘×§×© ×ž×ž×š ×œ×¢×–×•×‘ ×”×›×œ ×•×œ×‘×¦×¢ ×ž×©×™×ž×” ×©××ª×” ×¤×—×•×ª ××•×”×‘ (×›×ž×• ×¡×™×“×•×¨ ×ž×—×¡×Ÿ ××• × ×™×§×™×•×Ÿ). ×›×™×¦×“ ×ª×’×™×‘?", type: "text" },
    { id: 6, text: "××“×™×“×¡ ×”×™× ×¨×©×ª ×‘×™× ×œ××•×ž×™×ª ×¢× × ×”×œ×™× ×§×¤×“× ×™×™× (×ž×©×ž×¢×ª, × ×”×œ×™ ×§×•×¤×”, ×”×•×¤×¢×” ×™×™×¦×•×’×™×ª). ××™×š ××ª×” ×ž×¡×ª×“×¨ ×¢× ×¢×‘×•×“×” ×œ×¤×™ '×¡×¤×¨ ×—×•×§×™×' ×‘×¨×•×¨?", type: "text" },
    { id: 7, text: "×¡×¤×¨ ×¢×œ ×ž×§×¨×” ×©×‘×• ×”×™×” ×ž×ª×— ××• ×—×•×¡×¨ ×”×¡×›×ž×” ×‘×™× ×š ×œ×‘×™×Ÿ ×—×‘×¨ ×œ×¦×•×•×ª ×‘×¢×‘×•×“×”/×œ×™×ž×•×“×™×. ××™×š ×¤×ª×¨×ª× ××ª ×–×”?", type: "text" },
    { id: 8, text: "×”×× ×™×© ×œ×š ×¨×›×‘ ×¦×ž×•×“ ××• ×“×¨×š ×”×’×¢×” ×¢×¦×ž××™×ª ×œ×ž×©×ž×¨×•×ª (×›×•×œ×œ ×‘×¡×•×¤×™ ×©×‘×•×¢ ×•×—×’×™×)?", type: "text" },
    { id: 9, text: "×ž×”×™ ×”×–×ž×™× ×•×ª ×©×œ×š ×œ×ž×©×ž×¨×•×ª? (×›×ž×” ×ž×©×ž×¨×•×ª ×‘×©×‘×•×¢, ×‘×§×¨×™×/×¢×¨×‘×™×)", type: "text" }
];

app.get('/api/get-questions', (req, res) => {
    res.json(questions);
});

app.post('/api/submit-interview', async (req, res) => {
    const { candidate, answers } = req.body;
    
    console.log(`\nâ³ ×ž×¢×‘×“ ×¨×™××™×•×Ÿ ×¢×‘×•×¨: ${candidate.name}...`);

    try {
        let answersText = "";
        answers.forEach((ans) => {
            const questionObj = questions.find(q => q.id === ans.questionId);
            const qText = questionObj ? questionObj.text : "×©××œ×” ×œ× ×™×“×•×¢×”";
            answersText += `×©××œ×”: ${qText}\n×ª×©×•×‘×”: ${ans.answer}\n\n`;
        });

        const promptText = `
        ××ª×” ×ž× ×”×œ ×’×™×•×¡ ×ž×•×ž×—×” ×©×œ ×—×‘×¨×ª ××“×™×“×¡ (Adidas).
        ×§×™×‘×œ×ª ×¨××™×•×Ÿ ×¢×‘×•×“×” ×©×œ ×ž×•×¢×ž×“ ×‘×©× ${candidate.name} ×ž×¢×™×¨ ${candidate.city}.
        
        ×”× ×” ×”×ª×©×•×‘×•×ª ×©×œ ×”×ž×•×¢×ž×“:
        ${answersText}

        ×× × × ×ª×— ××ª ×”×ž×•×¢×ž×“ ×•×ª×Ÿ ×œ×™ ×¡×™×›×•× ×§×¦×¨ ×‘×¢×‘×¨×™×ª ×”×›×•×œ×œ:
        1. **×¨×•×©× ×›×œ×œ×™**: ×”×× ×”×ž×•×¢×ž×“ × ×©×ž×¢ ×¨×¦×™× ×™, ×©×™×¨×•×ª×™ ×•×ž×›×™×¨×ª×™?
        2. **× ×§×•×“×•×ª ×—×•×–×§**: ×ž×” ×‘×œ×˜ ×œ×˜×•×‘×” ×‘×ª×©×•×‘×•×ª ×©×œ×•?
        3. **× ×§×•×“×•×ª ×œ×©×™×¤×•×¨/×¡×™×›×•×Ÿ**: ×”×× ×™×© × ×•×¨×•×ª ××“×•×ž×•×ª?
        4. **×¦×™×•×Ÿ ×”×ª××ž×” (1-10)** ×œ×ª×¤×§×™×“ ×‘×—× ×•×ª ×¡×¤×•×¨×˜.
        5. **×”×ž×œ×¦×”**: ×œ×–×ž×Ÿ ×œ×¨××™×•×Ÿ? (×›×Ÿ/×œ×).
        `;

        // ×©×™×ž×•×© ×‘×ž×•×“×œ gemini-1.5-flash ×”×ž×¢×•×“×›×Ÿ
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: promptText }]
                }]
            })
        });

        const data = await response.json();

        if (data.error) {
            console.error("Error from Google:", data.error);
            throw new Error(data.error.message);
        }

        const analysis = data.candidates[0].content.parts[0].text;

        console.log("========================================");
        console.log(`ðŸ¤– ×“×•×— ×‘×™× ×” ×ž×œ××›×•×ª×™×ª: ${candidate.name}`);
        console.log(analysis);
        console.log("========================================");

        let summary = `×ª×•×“×” ×¨×‘×” ${candidate.name}.\n`;
        summary += "×”× ×ª×•× ×™× × ×§×œ×˜×• ×•×”×•×¢×‘×¨×• ×œ× ×™×ª×•×— ×‘×ž×¢×¨×›×ª.\n";
        summary += "×‘×ž×™×“×” ×•×ª×ž×¦× ×ž×ª××™×, × ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“×.";

        res.json({ message: summary });

    } catch (error) {
        console.error("System Error:", error);
        res.json({ message: "×”×¨×™××™×•×Ÿ × ×§×œ×˜ ×‘×”×¦×œ×—×”. ×ª×•×“×” ×¨×‘×”!" });
    }
});

app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});