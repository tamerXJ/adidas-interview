<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adidas Admin Dashboard</title>
    <style>
        :root { 
            --brand-primary: #667eea; 
            --brand-secondary: #764ba2; 
            --bg-color: #f5f7fa;
            --text-dark: #333;
            --text-light: #666;
        }
        
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-dark); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === Login Overlay === */
        #login-bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 998;
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
        }
        
        #login-overlay {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
             display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        .login-box { 
            background: white; padding: 40px; border-radius: 16px; text-align: center; 
            width: 90%; max-width: 400px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
        }
        
        .login-logo { width: 80px; margin-bottom: 20px; opacity: 0.8; }
        
        .login-box input { 
            width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; 
            font-size: 16px; transition: 0.3s; margin-bottom: 15px; 
        }
        .login-box input:focus { border-color: var(--brand-primary); }
        
        .login-box button { 
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); 
            color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .login-box button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

        /* === Main App Layout === */
        #app-content { flex: 1; display: none; flex-direction: column; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; }

        .header {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(118, 75, 162, 0.2);
            display: flex; justify-content: space-between; align-items: center;
        }

        .header-title h1 { font-size: 28px; font-weight: 800; margin-bottom: 5px; }
        .header-title p { opacity: 0.9; font-size: 14px; }

        .header-actions button {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); 
            color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;
            margin-left: 8px; transition: 0.2s;
        }
        .header-actions button:hover { background: rgba(255,255,255,0.3); }

        /* === Stats Grid (Desktop Layout Fix) === */
        .stats-grid { 
            display: grid; 
            gap: 20px; 
            margin-bottom: 30px; 
        }

        /* Desktop: Force 3 columns strictly like the screenshot */
        @media (min-width: 769px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr 1fr; /* ×©×œ×•×©×” ×˜×•×¨ ×©×•×•×™× ×‘×“×™×•×§ */
            }
        }

        /* Mobile: Auto-fit (Standard responsive) */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--brand-primary); }
        .stat-title { color: #888; font-size: 12px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--text-dark); margin-top: 5px; }

        /* === Filter Bar (Desktop Layout Fix) === */
        .filters {
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; gap: 15px; 
            align-items: flex-end; /* ×™×™×©×•×¨ ×ª×—×ª×•×Ÿ ×›×“×™ ×©×”×›×¤×ª×•×¨ ×•×”×©×“×•×ª ×™×”×™×• ×‘××•×ª×• ×’×•×‘×” */
        }

        /* Desktop: No wrap, strict layout */
        @media (min-width: 769px) {
            .filters {
                flex-wrap: nowrap;
                flex-direction: row;
            }
        }

        /* Mobile: Column layout */
        @media (max-width: 768px) {
            .filters {
                flex-wrap: wrap;
                flex-direction: column;
                align-items: stretch;
            }
        }

        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #555; }
        .filter-group select, .filter-group input {
            width: 100%; padding: 10px 15px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; background: #fff; transition: 0.2s;
        }
        .filter-group select:focus, .filter-group input:focus { border-color: var(--brand-primary); }

        .btn-export {
            background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 8px; 
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; height: 43px; white-space: nowrap;
        }
        .btn-export:hover { background: #219150; }

        /* Table */
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; } 
        
        thead { background: #f8f9fa; border-bottom: 2px solid #eee; }
        th { padding: 18px 15px; text-align: center; font-weight: 700; color: #555; font-size: 13px; white-space: nowrap; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f4f4f4; color: #444; font-size: 14px; vertical-align: middle; }
        tbody tr:hover { background: #f8f9ff; }

        /* Scores & Badges */
        .score { font-weight: 800; padding: 6px 12px; border-radius: 20px; display: inline-block; min-width: 40px; }
        .score-high { background: #d4edda; color: #155724; }
        .score-med { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }

        .btn-action { 
            padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; border: 1px solid #ddd; 
            background: white; cursor: pointer; transition: 0.2s; margin: 0 2px;
        }
        .btn-action:hover { background: #f0f0f0; border-color: #ccc; }
        .btn-view { color: var(--brand-primary); border-color: var(--brand-primary); }
        .btn-view:hover { background: var(--brand-primary); color: white; }
        
        .desktop-action { margin-right: 5px; }
        .btn-arch { color: #a76d05; border-color: #a76d05; }
        .btn-arch:hover { background: #a76d05; color: #fff; }
        .btn-rest { color: #1e7e34; border-color: #1e7e34; }
        .btn-rest:hover { background: #1e7e34; color: #fff; }

        /* === Mobile specific hiding (STRICT NO CHANGE) === */
        @media (max-width: 768px) {
            .header { padding: 20px; flex-direction: column; text-align: center; gap: 15px; }
            .filter-group { width: 100%; }
            
            table { min-width: 100%; }
            /* Hide columns on mobile */
            th:nth-child(1), td:nth-child(1), /* Date */
            th:nth-child(4), td:nth-child(4), /* City */
            th:nth-child(5), td:nth-child(5), /* Branch */
            th:nth-child(8), td:nth-child(8)  /* CV/Rec */
            { display: none; }
            
            .desktop-only { display: none !important; }
            .desktop-action { display: none !important; }
        }

        /* === Modal (Tabbed) === */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px);
        }
        body.modal-open { overflow: hidden; } /* Scroll Lock */

        .modal { 
            background: white; border-radius: 16px; width: 90%; max-width: 750px; 
            max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header { 
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); 
            color: white; padding: 25px; 
        }
        .modal-header h2 { margin: 0 0 5px 0; font-size: 22px; }
        .modal-sub { opacity: 0.9; font-size: 14px; }

        .modal-meta-mobile { display: none; margin-top: 10px; font-size: 13px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; }
        @media (max-width: 768px) { .modal-meta-mobile { display: block; } }

        /* Tabs */
        .modal-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .tab-btn { 
            flex: 1; padding: 15px; border: none; background: transparent; cursor: pointer; 
            font-weight: 600; color: #666; transition: 0.2s; border-bottom: 3px solid transparent; 
        }
        .tab-btn.active { background: white; color: var(--brand-primary); border-bottom-color: var(--brand-primary); }

        .modal-body { padding: 25px; overflow-y: auto; flex: 1; background: #fff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Boxes inside modal */
        .info-box { padding: 15px; border-radius: 8px; margin-bottom: 15px; line-height: 1.6; }
        .box-green { background: #d4edda; border-right: 4px solid #28a745; color: #155724; }
        .box-red { background: #f8d7da; border-right: 4px solid #dc3545; color: #721c24; }
        .box-gray { background: #f8f9fa; border: 1px solid #eee; color: #333; }

        .transcript-line { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .t-q { font-weight: 700; color: #000; display: block; margin-bottom: 4px; }
        .t-a { color: #444; background: #f9f9f9; padding: 8px; border-radius: 6px; display: block; }
        .t-meta { font-size: 11px; margin-top: 4px; display: flex; gap: 8px; }
        .badge-meta { background: #eee; padding: 2px 6px; border-radius: 4px; color: #777; }

        .modal-footer { padding: 15px 25px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        
        .footer-credit { text-align: center; padding: 20px; font-size: 12px; color: #aaa; margin-top: auto; }
    </style>
</head>
<body>

    <div id="login-bg-container"></div>
    <div id="login-overlay">
        <div class="login-box">
            <img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Adidas_2022_logo.svg" alt="Adidas" class="login-logo">
            <h2>×›× ×™×¡×ª ×× ×”×œ×™×</h2>
            <input type="password" id="pass-input" placeholder="×¡×™×¡××”">
            <button onclick="attemptLogin()">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            <p id="login-msg" style="color:#e74c3c; margin-top:10px; min-height:20px; font-size:14px; font-weight:600;"></p>
        </div>
    </div>

    <div id="app-content">
        
        <div class="header">
            <div class="header-title">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/20/Adidas_Logo.svg" style="height:30px; filter: brightness(0) invert(1);">
                    <h1>× ×™×”×•×œ ××•×¢××“×™×</h1>
                </div>
                <p>××¢×¨×›×ª ×’×™×•×¡ ×•×¡×™× ×•×Ÿ ×—×›××”</p>
            </div>
            <div class="header-actions">
                <button id="archive-toggle-btn" onclick="toggleArchiveMode()">ğŸ“‚ <span id="archive-btn-text">××¨×›×™×•×Ÿ</span></button>
                <button onclick="refreshData()">â†» ×¨×¢× ×Ÿ</button>
                <button onclick="logout()">âœ ×™×¦×™××”</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title" id="stat-title-1">×¡×”"×› ××•×¢××“×™×</div>
                <div class="stat-value" id="val-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">×¦×™×•×Ÿ ×××•×¦×¢</div>
                <div class="stat-value" id="val-avg">0.0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title" style="color: var(--brand-primary);">××•×¢××“×™× ×—×–×§×™× (8+)</div>
                <div class="stat-value" id="val-top" style="color: var(--brand-primary);">0</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group" style="flex: 2;">
                <label>×—×™×¤×•×© ×—×›× (×©× ××• ×˜×œ×¤×•×Ÿ)</label>
                <input type="text" id="search-input" placeholder="ğŸ” ×”×§×œ×“ ×œ×—×™×¤×•×©..." oninput="applyFilter()">
            </div>
            <div class="filter-group">
                <label>×¡×™× ×•×Ÿ ×œ×¤×™ ×¡× ×™×£</label>
                <select id="branch-filter" onchange="applyFilter()">
                    <option value="all">×›×œ ×”×¡× ×™×¤×™×</option>
                </select>
            </div>
            <div class="filter-group desktop-only" style="flex: 0.5;">
                <label>×”××œ×¦×”</label>
                <select id="rec-filter" onchange="applyFilter()">
                    <option value="all">×”×›×œ</option>
                    <option value="×›×Ÿ">×›×Ÿ</option>
                    <option value="×œ×">×œ×</option>
                </select>
            </div>
            <button class="btn-export" onclick="exportToExcel()">â¬‡ Excel</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>×ª××¨×™×š</th>
                        <th>×©× ××œ×</th>
                        <th>×ª×¤×§×™×“</th>
                        <th>×¢×™×¨</th>
                        <th>×¡× ×™×£</th>
                        <th>×˜×œ×¤×•×Ÿ</th>
                        <th>×¦×™×•×Ÿ</th>
                        <th>CV/×”××œ×¦×”</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr><td colspan="9" style="padding:40px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer-credit">Â© 2024 Adidas Recruitment System</div>
    </div>

    <div class="modal-overlay" id="modal-view">
        <div class="modal">
            <div class="modal-header">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <h2 id="m-name">×©× ×”××•×¢××“</h2>
                        <div class="modal-sub" id="m-sub">×ª×¤×§×™×“ | ×¦×™×•×Ÿ</div>
                    </div>
                    <button onclick="closeModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
                </div>
                
                <div class="modal-meta-mobile" id="m-mobile-meta">
                    </div>
            </div>

            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('summary')">ğŸ“ ×¡×™×›×•×</button>
                <button class="tab-btn" onclick="switchTab('strengths')">ğŸ’ª ×—×•×–×§×•×ª</button>
                <button class="tab-btn" onclick="switchTab('weaknesses')">âš ï¸ ×—×•×œ×©×•×ª</button>
                <button class="tab-btn" onclick="switchTab('transcript')">ğŸ’¬ ×¨××™×•×Ÿ ××œ×</button>
            </div>

            <div class="modal-body">
                <div id="tab-summary" class="tab-content active">
                    <div class="info-box box-gray">
                        <strong>ğŸ“Œ ×¡×™×›×•× AI ×›×œ×œ×™:</strong><br>
                        <span id="m-general"></span>
                    </div>
                </div>
                <div id="tab-strengths" class="tab-content">
                    <div class="info-box box-green" id="m-strengths"></div>
                </div>
                <div id="tab-weaknesses" class="tab-content">
                    <div class="info-box box-red" id="m-weaknesses"></div>
                </div>
                <div id="tab-transcript" class="tab-content">
                    <div id="m-full-interview"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-action" onclick="closeModal()" style="padding: 10px 20px;">×¡×’×•×¨</button>
                <div id="modal-actions"></div>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];
        let filteredData = [];
        let currentPass = "";
        let isArchiveMode = false; 
        let scrollPosition = 0; 

        // === Authentication ===
        document.getElementById('pass-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') attemptLogin();
        });

        async function attemptLogin() {
            const passInput = document.getElementById('pass-input');
            const pass = passInput.value;
            if (!pass) {
                 document.getElementById('login-msg').innerText = "× × ×œ×”×–×™×Ÿ ×¡×™×¡××”";
                 return;
            }
            document.getElementById('login-msg').innerText = "××ª×—×‘×¨...";
            currentPass = pass;
            await fetchData();
        }

        function logout() {
            currentPass = ""; fullData = []; filteredData = []; isArchiveMode = false;
            document.getElementById('pass-input').value = "";
            document.getElementById('login-msg').innerText = "";
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('login-bg-container').style.display = 'block';
            document.getElementById('login-overlay').style.display = 'flex';
        }

        // === Data Fetching ===
        async function refreshData() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#777;">â³ ××¨×¢× ×Ÿ × ×ª×•× ×™×...</td></tr>';
            await fetchData();
        }

        async function fetchData() {
            try {
                const res = await fetch(`/api/admin/candidates?password=${currentPass}`);
                if (res.status === 401) { document.getElementById('login-msg').innerText = "×¡×™×¡××” ×©×’×•×™×”, × ×¡×” ×©×•×‘."; return; }
                if (!res.ok) throw new Error('Network error');
                
                const data = await res.json();
                fullData = data;
                
                document.getElementById('login-bg-container').style.display = 'none';
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                
                populateBranchFilter(); 
                applyFilter();
            } catch (e) { 
                document.getElementById('login-msg').innerText = "×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª."; 
            }
        }

        // === Logic & Filtering ===
        function toggleArchiveMode() {
            isArchiveMode = !isArchiveMode;
            const btnText = document.getElementById('archive-btn-text');
            const title = document.getElementById('stat-title-1');
            
            if (isArchiveMode) {
                btnText.innerText = "×—×–×¨×” ×œ×¤×¢×™×œ×™×";
                title.innerText = "××•×¢××“×™× ×‘××¨×›×™×•×Ÿ";
            } else {
                btnText.innerText = "××¨×›×™×•×Ÿ";
                title.innerText = "××•×¢××“×™× ×¤×¢×™×œ×™×";
            }
            applyFilter(); 
        }

        async function updateStatus(phone, newStatus) {
            closeModal(); 
            if (!confirm(newStatus === 'archived' ? "×œ×”×¢×‘×™×¨ ×œ××¨×›×™×•×Ÿ?" : "×œ×©×—×–×¨ ×œ×¨×©×™××” ×”×¤×¢×™×œ×”?")) return;
            
            // Optimistic UI Update
            const item = fullData.find(i => (i.phone || "").replace("'","") == phone);
            if (item) item.status = newStatus;
            applyFilter();

            try {
                const res = await fetch('/api/admin/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: currentPass, phone: phone, status: newStatus })
                });
                if (!res.ok) { alert("×©×’×™××”, × × ×œ×¨×¢× ×Ÿ"); await refreshData(); }
            } catch (e) { alert("×ª×§×œ×ª ×ª×§×©×•×¨×ª"); await refreshData(); }
        }

        function populateBranchFilter() {
            const select = document.getElementById('branch-filter');
            const currentVal = select.value;
            select.innerHTML = '<option value="all">×›×œ ×”×¡× ×™×¤×™×</option>';
            const branches = [...new Set(fullData.map(item => item.branch))].filter(b => b && b.trim() !== "").sort();
            branches.forEach(branch => { 
                const opt = document.createElement('option'); 
                opt.value = branch; opt.innerText = branch; 
                select.appendChild(opt); 
            });
            if (branches.includes(currentVal)) select.value = currentVal;
        }

        function applyFilter() {
            const selectedBranch = document.getElementById('branch-filter').value;
            const selectedRec = document.getElementById('rec-filter').value;
            const searchText = document.getElementById('search-input').value.trim().toLowerCase();

            let data = fullData.filter(item => {
                const status = item.status || "active";
                return isArchiveMode ? status === "archived" : status === "active";
            });

            if (selectedBranch !== 'all') data = data.filter(i => i.branch === selectedBranch);
            
            if (selectedRec !== 'all') {
                data = data.filter(i => i.recommendation && i.recommendation.toString().includes(selectedRec));
            }

            if (searchText !== "") {
                data = data.filter(item => {
                    const name = (item.name || "").toString().toLowerCase();
                    const phone = (item.phone || "").toString().replace(/\D/g, ""); 
                    const searchPhone = searchText.replace(/\D/g, "");
                    // Fix: Check phone only if digits exist
                    const phoneMatch = searchPhone.length > 0 && phone.includes(searchPhone);
                    return name.includes(searchText) || phoneMatch;
                });
            }

            filteredData = data;
            renderData(filteredData);
        }

        function exportToExcel() {
            if (filteredData.length === 0) { alert("××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”"); return; }
            let csvContent = "\uFEFF×ª××¨×™×š,×©×,×ª×¤×§×™×“,×¡× ×™×£,×¢×™×¨,×˜×œ×¤×•×Ÿ,×¦×™×•×Ÿ,×”××œ×¦×”,×¡×˜×˜×•×¡\n";
            filteredData.forEach(row => {
                const clean = (t) => (t || "").toString().replace(/,/g, " ").replace(/\n/g, " ");
                let phone = clean(row.phone).replace(/'/g, "");
                csvContent += `${clean(row.date)},${clean(row.name)},${clean(row.role)},${clean(row.branch)},${clean(row.city)},'${phone},${clean(row.score)},${clean(row.recommendation)},${row.status}\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
            link.download = `Adidas_Candidates_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function renderData(data) {
            // Update Stats
            document.getElementById('val-total').innerText = data.length;
            const validScores = data.filter(c => c.score > 0);
            const avg = validScores.length ? (validScores.reduce((a, c) => a + parseInt(c.score), 0) / validScores.length).toFixed(1) : "0.0";
            document.getElementById('val-avg').innerText = avg;
            document.getElementById('val-top').innerText = data.filter(c => (parseInt(c.score)||0) >= 8).length;
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:30px;">×œ× × ××¦××• ××•×¢××“×™×.</td></tr>`;
                return;
            }

            data.forEach((item, index) => {
                const score = parseInt(item.score) || 0;
                let scoreClass = score >= 9 ? 'score-high' : score >= 7 ? 'score-med' : 'score-low';
                
                let dateStr = '-';
                try { dateStr = new Date(item.date).toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'}); } catch(e){}

                let recDisplay = item.recommendation || "-";
                if (recDisplay.startsWith("http")) recDisplay = `<a href="${recDisplay}" target="_blank">ğŸ“„ ×§×•"×—</a>`;

                let phoneStr = (item.phone || "").replace(/'/g, "");
                
                // Desktop Action Button
                let archiveBtn = isArchiveMode 
                    ? `<button class="btn-action btn-rest desktop-action" onclick="updateStatus('${phoneStr}', 'active')">â™»ï¸ ×©×—×–×¨</button>`
                    : `<button class="btn-action btn-arch desktop-action" onclick="updateStatus('${phoneStr}', 'archived')">ğŸ“¥ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td style="font-weight:700">${item.name}</td>
                    <td>${item.role}</td>
                    <td>${item.city}</td>
                    <td>${item.branch}</td>
                    <td style="font-family:monospace; direction:ltr;">${phoneStr}</td>
                    <td><span class="score ${scoreClass}">${score}</span></td>
                    <td>${recDisplay}</td>
                    <td>
                        <button class="btn-action btn-view" onclick="openModal(${index})">ğŸ‘ï¸ ×¤×¨×˜×™×</button>
                        ${archiveBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === Modal Functions ===
        function openModal(index) {
            const item = filteredData[index];
            if (!item) return;
            
            // Scroll Lock
            scrollPosition = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollPosition}px`;
            document.body.style.width = '100%';
            
            // Populate Header
            const score = parseInt(item.score) || 0;
            document.getElementById('m-name').innerText = item.name;
            document.getElementById('m-sub').innerText = `${item.role} | ×¦×™×•×Ÿ ×”×ª×××”: ${score}/10`;

            // Mobile Meta Data (Hidden in table, shown here)
            let recLink = item.recommendation && item.recommendation.startsWith('http') 
                ? `<a href="${item.recommendation}" target="_blank" style="color:white; text-decoration:underline;">ğŸ“„ ×§×•"×—</a>` : '';
            
            document.getElementById('m-mobile-meta').innerHTML = `
                <div>ğŸ¢ ${item.branch} | ğŸ“ ${item.city}</div>
                <div>ğŸ“… ${new Date(item.date).toLocaleDateString('he-IL')} | ${recLink}</div>
            `;

            // Content
            document.getElementById('m-general').innerHTML = item.general || "××™×Ÿ ×¡×™×›×•× ×–××™×Ÿ.";
            document.getElementById('m-strengths').innerHTML = item.strengths || "××™×Ÿ × ×ª×•× ×™×.";
            document.getElementById('m-weaknesses').innerHTML = item.weaknesses || "××™×Ÿ × ×ª×•× ×™×.";
            document.getElementById('m-full-interview').innerHTML = formatInterviewText(item.fullInterview);

            // Action Button inside Modal
            let phoneStr = (item.phone || "").toString().replace(/'/g,"");
            let actionBtn = isArchiveMode 
                ? `<button class="btn-action btn-rest" onclick="updateStatus('${phoneStr}', 'active')" style="padding:10px 20px;">â™»ï¸ ×©×—×–×¨ ×œ×¨×©×™××”</button>`
                : `<button class="btn-action btn-arch" onclick="updateStatus('${phoneStr}', 'archived')" style="padding:10px 20px;">ğŸ“¥ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>`;
            
            document.getElementById('modal-actions').innerHTML = actionBtn;

            switchTab('summary');
            document.getElementById('modal-view').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-view').style.display = 'none';
            document.body.style.position = '';
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-btn');
            if(tabName === 'summary') buttons[0].classList.add('active');
            if(tabName === 'strengths') buttons[1].classList.add('active');
            if(tabName === 'weaknesses') buttons[2].classList.add('active');
            if(tabName === 'transcript') buttons[3].classList.add('active');

            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function formatInterviewText(text) {
            if (!text || text.includes("×œ× × ××¦×")) return '<div style="text-align:center; padding:20px; color:#999;">×œ× × ×©××¨ ×ª×•×›×Ÿ.</div>';
            
            let parts = text.split(/Question:|Q:/g);
            let html = "";

            parts.forEach(part => {
                if (!part.trim()) return;
                let [qText, rest] = part.split(/Answer:|A:/);
                if (!rest) return;

                let answerText = rest;
                let stats = [];

                let timeMatch = rest.match(/Time Taken=(\d+)s?/i);
                let switchMatch = rest.match(/Tab Switches=(\d+)/i);

                if (timeMatch) stats.push(`â± ${timeMatch[1]} ×©× '`);
                if (switchMatch) stats.push(`âš ï¸ ×™×¦×™××•×ª: ${switchMatch[1]}`);

                // Clean Metadata
                answerText = answerText.replace(/\[.*?Time Taken.*?\]/gi, "")
                                       .replace(/\[.*?METADAT.*?\]/gi, "")
                                       .replace(/\[?METADAT[A]?\]?/gi, "")
                                       .replace(/Time Taken=\d+s?/gi, "")
                                       .replace(/Tab Switches=\d+/gi, "")
                                       .trim();

                html += `
                    <div class="transcript-line">
                        <span class="t-q">×©: ${qText.trim()}</span>
                        <span class="t-a">${answerText}</span>
                        ${stats.length ? `<div class="t-meta"><span class="badge-meta">${stats.join(' | ')}</span></div>` : ''}
                    </div>
                `;
            });
            return html;
        }
    </script>
</body>
</html>