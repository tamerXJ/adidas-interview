<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adidas Admin Dashboard</title>

<style>
/* === (CSS × ×©××¨ ×›××¢×˜ ×–×”×” â€“ ×§×™×¦×¨×ª×™ ×¤×” ×‘×ª×’×•×‘×” ×›×“×™ ×œ× ×œ×¤×•×¦×¥) === */
/* ××™×Ÿ ×©×™× ×•×™ ×¢×™×¦×•×‘×™ ××”×•×ª×™ */
</style>
</head>

<body>

<!-- ===== LOGIN ===== -->
<div id="login-overlay">
  <div class="login-box">
    <h2>×›× ×™×¡×ª ×× ×”×œ×™×</h2>
    <input id="pass-input" type="password" placeholder="×¡×™×¡××”">
    <button onclick="attemptLogin()">×›× ×™×¡×”</button>
    <p id="login-msg"></p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app-content" style="display:none">
  <button onclick="exportToExcel()">â¬‡ Excel</button>
  <table border="1" width="100%">
    <thead>
      <tr>
        <th>×ª××¨×™×š</th><th>×©×</th><th>×ª×¤×§×™×“</th><th>×¡× ×™×£</th>
        <th>×¢×™×¨</th><th>×˜×œ×¤×•×Ÿ</th><th>×¦×™×•×Ÿ</th><th>×”××œ×¦×”</th><th>×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
</div>

<!-- ===== MODAL ===== -->
<div id="modal" style="display:none; position:fixed; inset:0; background:#0008">
  <div style="background:#fff; margin:10%; padding:20px">
    <h3 id="m-name"></h3>
    <div id="m-content"></div>
    <button onclick="closeModal()">×¡×’×•×¨</button>
  </div>
</div>

<script>
let fullData = [];
let filteredData = [];
let currentPass = "";

/* ========= LOGIN ========= */
async function attemptLogin() {
  const input = document.getElementById('pass-input');
  const pass = input.value.trim();
  if (!pass) return showLoginMsg("× × ×œ×”×–×™×Ÿ ×¡×™×¡××”");

  showLoginMsg("××ª×—×‘×¨...");
  currentPass = pass;

  try {
    const res = await fetch('/api/admin/candidates', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password: pass })
    });

    if (res.status === 401) {
      input.value = "";
      input.focus();
      currentPass = "";
      return showLoginMsg("×¡×™×¡××” ×©×’×•×™×”");
    }

    fullData = await res.json();
    filteredData = fullData;

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app-content').style.display = 'block';
    renderTable();
  } catch {
    showLoginMsg("×©×’×™××ª ×©×¨×ª");
  }
}

function showLoginMsg(msg) {
  document.getElementById('login-msg').innerText = msg;
}

/* ========= TABLE ========= */
function renderTable() {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = "";

  filteredData.forEach(item => {
    const phone = normalizePhone(item.phone);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDate(item.date)}</td>
      <td>${item.name || '-'}</td>
      <td>${item.role || '-'}</td>
      <td>${item.branch || '-'}</td>
      <td>${item.city || '-'}</td>
      <td>${phone}</td>
      <td>${item.score || 0}</td>
      <td>${item.recommendation || '-'}</td>
      <td>
        <button onclick="openModal('${phone}')">ğŸ”</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========= MODAL ========= */
function openModal(phone) {
  const item = filteredData.find(i => normalizePhone(i.phone) === phone);
  if (!item) return;

  document.getElementById('m-name').innerText = item.name || '××•×¢××“';
  document.getElementById('m-content').innerText =
    item.general || "××™×Ÿ ××™×“×¢";

  document.getElementById('modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

/* ========= CSV ========= */
function exportToExcel() {
  if (!filteredData.length) return alert("××™×Ÿ × ×ª×•× ×™×");

  let csv = "\uFEFF";
  csv += "×ª××¨×™×š,×©×,×ª×¤×§×™×“,×¡× ×™×£,×¢×™×¨,×˜×œ×¤×•×Ÿ,×¦×™×•×Ÿ,×”××œ×¦×”,×¡×˜×˜×•×¡\n";

  filteredData.forEach(r => {
    const clean = v => `"${(v||"").toString().replace(/"/g,'""')}"`;
    const phone = normalizePhone(r.phone);

    csv += [
      clean(r.date),
      clean(r.name),
      clean(r.role),
      clean(r.branch),
      clean(r.city),
      clean(phone),
      clean(r.score),
      clean(r.recommendation),
      clean(r.status || 'active')
    ].join(',') + "\n";
  });

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "candidates.csv";
  a.click();
}

/* ========= HELPERS ========= */
function normalizePhone(p) {
  if (!p) return "";
  p = p.toString().replace(/'/g,'');
  if (!p.startsWith('0') && p.length > 8) p = '0' + p;
  return p;
}

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString('he-IL');
  } catch {
    return d || "-";
  }
}
</script>
</body>
</html>
